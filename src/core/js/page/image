'use strict';

// 页面实例

var fs = require('fs');
var path = require('path');
var exec = require('child_process').exec;
var lib = require('linco.lab').lib;
var LoadImage = require('../lib/loadimage');
var Page = require('../lib/page');
var page = new Page;

var dragTargetFolder = "/Volumes/Mobile/cate";
var sourceFolder = "/Volumes/Mobile/aitushuo";

var loadImage = new LoadImage(sourceFolder, 50);

var selectImg = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAAe1BMVEUAAAD///////////////////////////////////////////////////////////////8blfv///+23f5jt/whmPsdlvvK5/5Hqvyu2f4qnPs6pPyj1f2Cxf1bs/z0+v/////j8v9tvPxVsPyTzf13wf3T6v7a7v7r9v8SOWehAAAAEXRSTlMAT2fmjwUnF3TWWJTZvL27CNRr2pIAAAHTSURBVEjHpVZpk4IwDO0qyOGxwysUKIfj7f//hSsFCaVQ1vF9cBhJSPJempQZ8EJnv8YL670TemwBnh9AQ+B7NnMHL/CqLmSSyKKuOF7Yzrm4fmMdi2gAETc+vjtlvwkAnkUGshzYbUz7HyCNo0nEKfAztl8BeRLNQOTAyrAvIwvKtwflc46sOGtZbej7thh95e4OebSIHLs3uz5SsewgUvidvgDxOcNr3fwCrebbpYQy4NEmte0CZFb74glUnaOnKuBWe/noOeSqigDxQq1Ik64WBCojscD/Q76dm5xCe0YV8CwGWoTMQWUjFMBl6O6wPWoLoUe9yWr8sjVURFHLCUJPwFX7A2sGKMuyp4KQ3DHSVAIMUI8pDL0Fh/GV3oHkJFyBkxzFVA6yr09T8AYcs7HqgCpaIdYNLkSoXjTRWgGnon91BG5kSbQOhcuBe9LFHhFKwg1bI0kBLgZPBGoNaj76LsUiUPNp7Z21mV+7agjU3nSAiJuzSSgdIDqixD4pYpxtzxwCJUCaE2gIjMeM4DNjkMYM87Uek3x6jCf9IGNu8L9RGbifDuNPx/0XC+XDlUVLcWZ+1LQUx2s3X1i7Xy325avD95cTuv4c2uvPYer68webMIGKNytpEAAAAABJRU5ErkJggg==';

page.extend({
	name: "images",
	id: "image",

	init: function(){
		console.log('init ' + this.id)
	},

	enter: function(){
		var main, aside, lessFolder, ul;
		var listImage, ulImage, getMoreImage;
		// 如果需要页面需要reload
		// window下的子方法获取要定义在enter方法内
		var doc = window.document;
		var $ = window.$;
		var home = window.home;
		var _this = this;

		// 载入页面
		console.log('enter ' + this.id);

		// 渲染aside
		this.render('asideInner', this.dom.aside, this.data.aside);

		main = $('#mainInner');
		aside = $('#asideInner');
		lessFolder = $('#lessFolder');
		ul = lessFolder.find('ul');


		function init(){
			renderImage()

			// 监听图片click事件
			main.delegate('li', 'click', function(){
				var li = $(this);

				if(li.parents('#listImage').length > 0){
					if(li.hasClass('current')){
						li.removeClass('current');
						// li.find('.iselected').remove();
					}else{
						li.addClass('current').siblings('.current').removeClass('current');
						li.find('.iselected').length == 0 ?
							li.append('<img class="iselected" src="'+selectImg+'">'):"";
					}
				}

			})

			// 预览图片
			doc.onkeypress = function(e){
				var li, src;
				var url = 'image.html';
				var imageDom;
				var img;
				var win;

				// 监听空格键
				if(e.keyCode == 32){
					// 判断是否有图片被选中
					li = main.find('li.current');

					if(li.length == 1){
						src = li.attr('path');

						_this.shell.file(src)
						return false;

						url += '?imgurl='+src;
						
						// 如果不存在预览窗口则创建
						if(!win){
							img = new window.Image();
							img.src = src;
							img.onload = function(){
								win = new View(url, {width: img.width, height: img.height});
							}
						}else{
							// 如果已存在预览窗口则激活
							win.focus();
							// 打开新的图片
							imageDom = win.window.document.getElementById('image');
							if(imageDom){
								imageDom.src = src;
							}
						}

						return false;
					}
				}
			}
		}

		// 封装新建窗口方法
		function View(url, opt){
			var gui = window.gui;
			var win;
			// 默认窗口参数
			var def = {
				position: 'center',
				width: 800,
				height: 600,
				focus: true,
				toolbar: true,
				frame: true
			};
			// 合并参数
			opt = lib.extend(def, opt);

			// 新建窗口
			win = gui.Window.get(
				window.open(url)
			);
			// win = gui.Window.open(url, opt);

			// 设置大小
			win.resizeTo(opt.width, opt.height);

			// 激活预览窗口
			win.focus();
			win.setPosition('center')

			// 定义新窗口事件监听
			win.on('close', function(){
				this.hide();
				if(win != null)
					win.close(true)
				this.close(true);
			})
			win.on('closed', function() {
				win = null;
			});
			win.on('focus', function(){
				console.log('is focus')
				console.log(win.window.location)
			})
			win.on('blur', function(){
				console.log('is blur')
			})

			return win;
		}

		// 初次渲染列表
		function renderImage(){
			listImage = $('#listImage');
			ulImage = listImage.find('ul');
			getMoreImage = listImage.find('#getMoreImage');

			getMoreImage.click(function(){
				renderMoreImage();
			})

			renderMoreImage();
		}

		// 加载更多图片
		function renderMoreImage(){
			var imgs = loadImage.more();
			var Image = window.Image;

			imgs.forEach(function(item){
				var img = new Image();
				img.src = item;
				img.onload = function(){
					addImage({path: item})
				}
			})
		}

		// 加载图片方法
		function addImage(file){
			var src = file.path;

			// 转义路径中的特殊字符
			file.path.match(/\'/g) ?
				file.path = file.path.replace(/\'/g, '\\\'') : "";
			file.path.match(/\(|\)/g) ?
				file.path = file.path.replace(/\(/g, '\\\(').replace(/\)/g, '\\\)') : "";

			ulImage.append('<li draggable="true" path="'+src+'" style="background-image: url('+file.path+')"></li>')
		}

		// 添加文件夹方法
		function add(file){
			ul.append('<li path="'+file.path+'">'+file.name+'</li>')
		}

		// 监听drag事件
		home.drag(this.id, function(e){
			var files = e.dataTransfer.files;

			lib.each(files, function(i, item){
				if(lib.isDir(item.path)){
					add(item);
				}
			})
		})

		function dragListFolder(){
			var imageListDrag = $('#imageListDrag');
			var ul = imageListDrag.find('ul');
			var folder = [];
			var draged, target, src, dirpath, dirname;

			listImage = $('#listImage');
			ulImage = listImage.find('ul');

			fs.readdir(dragTargetFolder, function(e, arr){
				arr.forEach(function(item){
					var src = path.join(dragTargetFolder, item)
					if(lib.isDir(src)){
						ul.append('<li path="'+src+'">'+item+'</li>')
					}
				})
			})

			// 监听拖拽事件
			ulImage.get(0).addEventListener('dragstart', function(e){
				// e.stopPropagation();
				// e.preventDefault();
				// console.log(e.target)
				draged = e.target;
			}, false)

			ul.get(0).addEventListener('dragover', function(e){
				e.stopPropagation();
				e.preventDefault();
				$(e.target).removeClass('droped').addClass('dragover');
			}, false)

			ul.get(0).addEventListener('dragleave', function(e){
				e.stopPropagation();
				e.preventDefault();
				$(e.target).removeClass('dragover');
			}, false)

			ul.get(0).addEventListener('drop', function(e){
				e.stopPropagation();
				e.preventDefault();
				$(e.target).addClass('droped').removeClass('dragover');

				// 图片真实路径
				src = $(draged).attr('path');
				// 图片文件夹路径
				dirpath = path.dirname(src);
				// 图片文件夹名称
				dirname = path.basename(dirpath);
				target = $(e.target).attr('path');
				target = path.join(target, dirname);

				// console.log(src)
				// console.log(dirpath)
				// console.log(dirname)
				// console.log(target)

				moveFolder(dirpath, target, draged);

			}, false)
		}
		dragListFolder();


		function moveFolder(source, target, el){
			console.log(source, target)
			el.remove();
			exec('mv ' + source + ' ' + target, function(){
				console.log(arguments)
			});
		}

		function dropImage(){
			var ul;
			listImage = $('#listImage');
			ulImage = listImage.find('ul');
			ul = ulImage.get(0);

			// ul.addEventListener('drag')

		}
		// dropImage();


		// fire init
		init();
	},

	leave: function(){
		console.log('leave ' + this.id)
	},

	dom: {
		aside: ''+
				'<div id="lessFolder" class="list-folder">'+
				'	<ul>'+
				'	<%for(var i=0, len=list.length;i<len; i++){%>'+
				'		<li class="selected" path="<%=list[i].path%>"><%=list[i].name%></li>'+
				'	<%}%>'+
				'	</ul>'+
				'</div>',

		main: ''

	},

	data: {
		aside: {
			list: [
				{
					name: 'aitushuo',
					path: '/Volumes/Mobile/aitushuo'
				}
			]
		}
	},

	ready: function(){

	}
});

// 如果需要可以启用初始化方法，二次进入虚拟页需要重新刷新数据
// page.init();
page.reg();


module.exports = page;